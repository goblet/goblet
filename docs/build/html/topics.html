

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Topics &mdash; goblet 0.6.2 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Resources" href="resources.html" />
    <link rel="prev" title="Quickstart" href="quickstart.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> goblet
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Topics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#routing">Routing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#config">Config</a></li>
<li class="toctree-l2"><a class="reference internal" href="#iam-bindings">Iam Bindings</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run-locally">Run Locally</a></li>
<li class="toctree-l2"><a class="reference internal" href="#debugging-with-vscode">Debugging with VScode</a></li>
<li class="toctree-l2"><a class="reference internal" href="#authentication">Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="#request">Request</a></li>
<li class="toctree-l2"><a class="reference internal" href="#response">Response</a></li>
<li class="toctree-l2"><a class="reference internal" href="#openapi-spec">OpenApi Spec</a></li>
<li class="toctree-l2"><a class="reference internal" href="#multiple-files">Multiple Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#stages">Stages</a></li>
<li class="toctree-l2"><a class="reference internal" href="#api-gateway-backends">API Gateway Backends</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cors">Cors</a></li>
<li class="toctree-l2"><a class="reference internal" href="#multiple-cloudfunctions">Multiple Cloudfunctions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#syncing-state">Syncing State</a></li>
<li class="toctree-l2"><a class="reference internal" href="#middleware">Middleware</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="resources.html">Resources</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="backends.html">Backends</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="blogs.html">Blogs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="integrations.html">Integrations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">goblet</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Topics</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/topics.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="topics">
<h1>Topics<a class="headerlink" href="#topics" title="Permalink to this headline">¶</a></h1>
<div class="section" id="routing">
<h2>Routing<a class="headerlink" href="#routing" title="Permalink to this headline">¶</a></h2>
<p>The Goblet.route() method is used to construct which routes you want to create for your API.
The concept is the same mechanism used by Flask. You decorate a function with &#64;app.route(…),
and whenever a user requests that URL, the function you’ve decorated is called. For example,
suppose you deployed this app:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">goblet</span> <span class="kn">import</span> <span class="n">Goblet</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Goblet</span><span class="p">(</span><span class="n">function_name</span><span class="o">=</span><span class="s1">&#39;helloworld&#39;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;view&#39;</span><span class="p">:</span> <span class="s1">&#39;index&#39;</span><span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/a&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">a</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;view&#39;</span><span class="p">:</span> <span class="s1">&#39;a&#39;</span><span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/b&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">b</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;view&#39;</span><span class="p">:</span> <span class="s1">&#39;b&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>If you go to <a class="reference external" href="https://endpoint/">https://endpoint/</a>, the index() function would be called. If you went to <a class="reference external" href="https://endpoint/a">https://endpoint/a</a> and <a class="reference external" href="https://endpoint/b">https://endpoint/b</a>, then the a() and b() function would be called, respectively.</p>
<p>You can also create a route that captures part of the URL. This captured value will then be passed in as arguments to your view function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/users/</span><span class="si">{name}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">users</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">}</span>
</pre></div>
</div>
<p>If you then go to <a class="reference external" href="https://endpoint/users/james">https://endpoint/users/james</a>, then the view function will be called as: users(‘james’).
The parameters are passed as keyword parameters based on the name as they appear in the URL.
The argument names for the view function must match the name of the captured argument:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/a/</span><span class="si">{first}</span><span class="s1">/b/</span><span class="si">{second}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">users</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;first&#39;</span><span class="p">:</span> <span class="n">first</span><span class="p">,</span> <span class="s1">&#39;second&#39;</span><span class="p">:</span> <span class="n">second</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="config">
<h2>Config<a class="headerlink" href="#config" title="Permalink to this headline">¶</a></h2>
<p>You can provide custom configurations for your cloudfunctions and goblet deployment by using the config.json file which should be
located in the .goblet folder. If one doesn’t exist then you should add one.</p>
<p>To provide custom values for the cloudfunction configuration pass in your desired overrides in the <code class="docutils literal notranslate"><span class="pre">cloudfunction</span></code> key. See below for example.</p>
<p>Example fields include</p>
<ul class="simple">
<li><p>environmentVariables</p></li>
<li><p>labels</p></li>
<li><p>availableMemoryMb</p></li>
<li><p>timeout</p></li>
</ul>
<p>Example config.json:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;cloudfunction&quot;</span><span class="p">:{</span>
        <span class="nt">&quot;environmentVariables&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;env1&quot;</span><span class="p">:</span><span class="s2">&quot;var1&quot;</span><span class="p">},</span>
        <span class="nt">&quot;labels&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;label1&quot;</span><span class="p">:</span><span class="s2">&quot;val1&quot;</span><span class="p">},</span>
        <span class="nt">&quot;availableMemoryMb&quot;</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span>
        <span class="nt">&quot;timeout&quot;</span><span class="p">:</span> <span class="s2">&quot;30s&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>see the <a class="reference external" href="https://cloud.google.com/functions/docs/reference/rest/v1/projects.locations.functions#CloudFunction">cloudfunction</a> docs for more details on the fields.</p>
<p>By default goblet includes all python files located in the directory. To include other files use the <code class="docutils literal notranslate"><span class="pre">customFiles</span></code> key
which takes in a list of python <a class="reference external" href="https://docs.python.org/3/library/glob.html">glob</a> formatted strings.</p>
<p>Example config.json:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;customFiles&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;*.yaml&quot;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can customize the configs for an Api Gateway using the <cite>apiConfig</cite> key in <cite>config.json</cite>. Allowed fields can be found
<a class="reference external" href="https://cloud.google.com/api-gateway/docs/reference/rest/v1/projects.locations.apis.configs#ApiConfig">here</a> and include</p>
<ul class="simple">
<li><p>gatewayServiceAccount</p></li>
<li><p>labels</p></li>
<li><p>displayName</p></li>
</ul>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;apiConfig&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;gatewayServiceAccount&quot;</span><span class="p">:</span> <span class="s2">&quot;projects/-/serviceAccounts/ServiceAccount@PROJECT&quot;</span><span class="p">,</span>
        <span class="nt">&quot;labels&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;label1&quot;</span> <span class="p">:</span> <span class="s2">&quot;value1&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="iam-bindings">
<h2>Iam Bindings<a class="headerlink" href="#iam-bindings" title="Permalink to this headline">¶</a></h2>
<p>You can add Iam bindings to your cloudfunctions by adding a <cite>binding</cite> section to your <cite>congig.json</cite> file.
The bindings should be in the <a class="reference external" href="https://cloud.google.com/functions/docs/reference/rest/v1/Policy">GCP Policy format</a></p>
<p>For example to allow unauthenticated (public) access to your cloudfunctions you would add the <cite>roles/cloudfunctions.invoker</cite> to
member <cite>allUsers</cite></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;bindings&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;roles/cloudfunctions.invoker&quot;</span><span class="p">,</span>
            <span class="nt">&quot;members&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;allUsers&quot;</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To remove bindings once they are deploy you should update your <cite>bindings</cite> in <cite>config.json</cite> and change the <cite>members</cite> to be an empty list</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;bindings&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;roles/cloudfunctions.invoker&quot;</span><span class="p">,</span>
            <span class="nt">&quot;members&quot;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="run-locally">
<h2>Run Locally<a class="headerlink" href="#run-locally" title="Permalink to this headline">¶</a></h2>
<p>Running your functions locally for testing and debugging is easy to do with the goblet command <cite>goblet local</cite>.
You can hit your functions endpoint at <code class="docutils literal notranslate"><span class="pre">localhost:8080</span></code>.</p>
<p>You can have a custom local name by seting the local param in the goblet class</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">goblet</span> <span class="kn">import</span> <span class="n">Goblet</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Goblet</span><span class="p">(</span><span class="n">function_name</span><span class="o">=</span><span class="s2">&quot;goblet_example&quot;</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Then run <code class="docutils literal notranslate"><span class="pre">goblet</span> <span class="pre">local</span> <span class="pre">test</span></code></p>
<p>Note: If you have both <cite>http()</cite> and <cite>route(“/”)</cite> in order to test the route locally make sure to add the header <code class="docutils literal notranslate"><span class="pre">X-Envoy-Original-Path</span></code>. Otherwise the route will default to <code class="docutils literal notranslate"><span class="pre">&#64;http()</span></code></p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl localhost:8080/endpoint
</pre></div>
</div>
<p>To test a scheduled job locally you will need to include two headers in your request. One <code class="docutils literal notranslate"><span class="pre">X-Goblet-Type:schedule</span></code> and
<code class="docutils literal notranslate"><span class="pre">X-Goblet-Name:FUNCTION_NAME</span></code> which is the name of your function.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl -H X-Goblet-Type:schedule -H X-Goblet-Name:FUNCTION_NAME localhost:8080
</pre></div>
</div>
</div>
<div class="section" id="debugging-with-vscode">
<h2>Debugging with VScode<a class="headerlink" href="#debugging-with-vscode" title="Permalink to this headline">¶</a></h2>
<p>To debug your functions locally with Vscode you can use the following configuration. Replace LOCAL_NAME with the name you
passed into <code class="docutils literal notranslate"><span class="pre">goblet(NAME,</span> <span class="pre">local=LOCAL_NAME)</span></code>. Make sure that there are no naming collisions with any function names used in your app.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;configurations&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Python: Module&quot;</span><span class="p">,</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
            <span class="nt">&quot;request&quot;</span><span class="p">:</span> <span class="s2">&quot;launch&quot;</span><span class="p">,</span>
            <span class="nt">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;functions_framework&quot;</span><span class="p">,</span>
            <span class="nt">&quot;args&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;--target&quot;</span><span class="p">,</span>
                <span class="s2">&quot;LOCAL_NAME&quot;</span><span class="p">,</span>
                <span class="s2">&quot;--debug&quot;</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="authentication">
<h2>Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h2>
<p>API gateway supports several authentication options including, <a class="reference external" href="https://cloud.google.com/api-gateway/docs/authenticating-users-jwt">jwt</a>, <a class="reference external" href="https://cloud.google.com/api-gateway/docs/authenticating-users-firebase">firebase</a>, <a class="reference external" href="https://cloud.google.com/api-gateway/docs/authenticating-users-auth0">auth0</a>, <a class="reference external" href="https://cloud.google.com/api-gateway/docs/authenticating-users-okta">Okta</a>, <a class="reference external" href="https://cloud.google.com/api-gateway/docs/authenticating-users-googleid">google_id</a>,</p>
<p>To configure authentication with goblet simply add the desired configuration in the <code class="docutils literal notranslate"><span class="pre">securityDefinitions</span></code> option in config.json. See the
API gateway docs linked above for more details on how to set up the configuration.</p>
<p>An api using JWT authentication would require the following in <code class="docutils literal notranslate"><span class="pre">config.json</span></code></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;securityDefinitions&quot;</span><span class="p">:{</span>
        <span class="nt">&quot;your_custom_auth_id&quot;</span><span class="p">:{</span>
            <span class="nt">&quot;authorizationUrl&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="nt">&quot;flow&quot;</span><span class="p">:</span> <span class="s2">&quot;implicit&quot;</span><span class="p">,</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;oauth2&quot;</span><span class="p">,</span>
            <span class="nt">&quot;x-google-issuer&quot;</span><span class="p">:</span> <span class="s2">&quot;issuer of the token&quot;</span><span class="p">,</span>
            <span class="nt">&quot;x-google-jwks_uri&quot;</span><span class="p">:</span> <span class="s2">&quot;url to the public key&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This generates a <a class="reference external" href="https://swagger.io/docs/specification/2-0/authentication/">security section</a> in the openapi
spec with empty scopes. If you would like to customize the security section and add custom scopes use the <cite>security</cite>
section in <cite>config.json</cite></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;security&quot;</span><span class="p">:[</span>
        <span class="p">{</span>
            <span class="nt">&quot;OAuth2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;read&quot;</span><span class="p">,</span> <span class="s2">&quot;write&quot;</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If you would like to apply security at the method level then you can add security policy in the route decorator.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/method_security&#39;</span><span class="p">,</span> <span class="n">security</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;your_custom_auth_id&quot;</span><span class="p">:</span> <span class="p">[]}])</span>
</pre></div>
</div>
<p>Another common use case is to authenticate via a service account, which requires the follow secuirty definition. You can specify
multiple service accounts by adding additional entries to the <cite>securityDefinitions</cite> dictionary.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;securityDefinitions&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;SERVICE_ACCOUNT_NAME&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;authorizationUrl&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="nt">&quot;flow&quot;</span><span class="p">:</span> <span class="s2">&quot;implicit&quot;</span><span class="p">,</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;oauth2&quot;</span><span class="p">,</span>
            <span class="nt">&quot;x-google-audiences&quot;</span><span class="p">:</span> <span class="s2">&quot;SERVICE_ACCOUNT_EMAIL&quot;</span><span class="p">,</span>
            <span class="nt">&quot;x-google-issuer&quot;</span><span class="p">:</span> <span class="s2">&quot;SERVICE_ACCOUNT_EMAIL&quot;</span><span class="p">,</span>
            <span class="nt">&quot;x-google-jwks_uri&quot;</span><span class="p">:</span> <span class="s2">&quot;https://www.googleapis.com/service_accounts/v1/metadata/x509/SERVICE_ACCOUNT_EMAIL&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now to access your api endpoint you can use the following python script to generate a jwt token and add it as a bearer token to your request.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">oauth2client.client</span> <span class="kn">import</span> <span class="n">GoogleCredentials</span>
<span class="kn">from</span> <span class="nn">googleapiclient</span> <span class="kn">import</span> <span class="n">discovery</span>

<span class="k">def</span> <span class="nf">generate_jwt_payload</span><span class="p">(</span><span class="n">service_account_email</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates jwt payload&quot;&quot;&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;iat&#39;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
        <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">now</span> <span class="o">+</span> <span class="mi">3600</span><span class="p">,</span>
        <span class="s1">&#39;iss&#39;</span><span class="p">:</span> <span class="n">service_account_email</span><span class="p">,</span>
        <span class="s1">&#39;aud&#39;</span><span class="p">:</span>  <span class="n">service_account_email</span><span class="p">,</span>
        <span class="s1">&#39;sub&#39;</span><span class="p">:</span> <span class="n">service_account_email</span><span class="p">,</span>
        <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">service_account_email</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">payload</span>

<span class="k">def</span> <span class="nf">get_jwt</span><span class="p">(</span><span class="n">service_account_email</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate a signed JSON Web Token using a Google API Service Account.&quot;&quot;&quot;</span>

    <span class="n">credentials</span> <span class="o">=</span> <span class="n">GoogleCredentials</span><span class="o">.</span><span class="n">get_application_default</span><span class="p">()</span>
    <span class="n">service</span> <span class="o">=</span> <span class="n">discovery</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="s1">&#39;iamcredentials&#39;</span><span class="p">,</span> <span class="s1">&#39;v1&#39;</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">)</span>
    <span class="n">body</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">generate_jwt_payload</span><span class="p">(</span><span class="n">service_account_email</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="n">encoded_sa</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">service_account_email</span><span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">projects</span><span class="p">()</span><span class="o">.</span><span class="n">serviceAccounts</span><span class="p">()</span><span class="o">.</span><span class="n">signJwt</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;projects/-/serviceAccounts/</span><span class="si">{</span><span class="n">encoded_sa</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">resp</span><span class="p">[</span><span class="s2">&quot;signedJwt&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">make_jwt_request</span><span class="p">(</span><span class="n">service_account_email</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Makes an authorized request to the endpoint&quot;&quot;&quot;</span>
    <span class="n">signed_jwt</span> <span class="o">=</span> <span class="n">get_jwt</span><span class="p">(</span><span class="n">service_account_email</span><span class="p">)</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="s1">&#39;Bearer </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">signed_jwt</span><span class="p">),</span>
        <span class="s1">&#39;content-type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span>
    <span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">make_jwt_request</span><span class="p">(</span><span class="n">SERVICE_ACCOUNT_EMAIL</span><span class="p">,</span><span class="n">GATEWAY_URL</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="request">
<h2>Request<a class="headerlink" href="#request" title="Permalink to this headline">¶</a></h2>
<p>The route path can only contain [a-zA-Z0-9._-] chars and curly braces for parts of the URL you want to capture.
To access other parts of the request including headers, query strings, and post data you can use <code class="docutils literal notranslate"><span class="pre">app.current_request</span></code> to get
the request object. To see all fields see <a class="reference external" href="https://tedboy.github.io/flask/generated/generated/werkzeug.Request.html">request</a>
Note, that this also means you cannot control the routing based on query strings or headers.
Here’s an example for accessing query string data in a view function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/users/</span><span class="si">{name}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">users</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">current_request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;include-greeting&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;greeting&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Hello, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>Here’s an example for accessing post data in a view function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/users}&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">users</span><span class="p">():</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">current_request</span><span class="o">.</span><span class="n">json</span>
    <span class="k">return</span> <span class="n">json_data</span>
</pre></div>
</div>
<p>To see the full list of available fields see <a class="reference external" href="https://tedboy.github.io/flask/generated/generated/werkzeug.Request.html">request</a></p>
<p>In some cases there is additional context passed with the event. For example for pubsub events. This context can be accessed via <cite>app.request_context</cite></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">topic</span><span class="p">(</span><span class="s2">&quot;TOPIC&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">context</span><span class="p">():</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">request_context</span>
    <span class="k">return</span> <span class="s2">&quot;context&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="response">
<h2>Response<a class="headerlink" href="#response" title="Permalink to this headline">¶</a></h2>
<p>Goblet http function response should be of the form a flask <a class="reference external" href="https://flask.palletsprojects.com/en/1.1.x/api/#flask.Response">response</a>. See more at the <a class="reference external" href="https://cloud.google.com/functions/docs/writing/http">cloudfunctions</a> documentation</p>
<p>To see the full list of available fields see <a class="reference external" href="https://flask.palletsprojects.com/en/1.1.x/api/#flask.Response">response</a></p>
<p>You can use goblet’s <code class="docutils literal notranslate"><span class="pre">Response</span></code> class to make it easier to pass in custom headers and response codes.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">goblet</span> <span class="kn">import</span> <span class="n">Response</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/response&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">response</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">},</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">},</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
</pre></div>
</div>
<p>Another option is goblet’s <code class="docutils literal notranslate"><span class="pre">jsonify</span></code>, which is a helper to create response objects.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">goblet</span> <span class="kn">import</span> <span class="n">jsonify</span>

<span class="n">jsonify</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>This function wraps dumps() to add a few enhancements that make life easier. It turns the JSON output into a Response
object with the application/json mimetype. For convenience, it also converts multiple arguments into an array or
multiple keyword arguments into a dict. This means that both jsonify(1,2,3) and jsonify([1,2,3]) serialize to [1,2,3].</p>
<p>For clarity, the JSON serialization behavior has the following differences from dumps():</p>
<p>Single argument: Passed straight through to dumps().</p>
<p>Multiple arguments: Converted to an array before being passed to dumps().</p>
<p>Multiple keyword arguments: Converted to a dict before being passed to dumps().</p>
<p>Both args and kwargs: Behavior undefined and will throw an exception.</p>
<p>Example usage:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/get_current_user&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_current_user</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                <span class="n">email</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</div>
<p>This will send a JSON response like this to the browser:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
    <span class="nt">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;admin@localhost&quot;</span><span class="p">,</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">42</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="openapi-spec">
<h2>OpenApi Spec<a class="headerlink" href="#openapi-spec" title="Permalink to this headline">¶</a></h2>
<p>Goblet generates an <a class="reference external" href="https://swagger.io/specification/">OpenApi</a> spec from your route endpoints in order to create the api gateway. The open api spec is written to the
<code class="docutils literal notranslate"><span class="pre">.goblet</span></code> folder and can be used for other tools. To generate just the open api spec you can run the command <code class="docutils literal notranslate"><span class="pre">goblet</span> <span class="pre">openapi</span> <span class="pre">FUNCTION_NAME</span></code>.
Note that gcp <a class="reference external" href="https://cloud.google.com/api-gateway/docs/openapi-overview">gateway</a> only supports openapi spec 2.0.</p>
<p>By default the param types will be created in the spec as strings and a base 200 response.
You can specify custom param and response types using python typing and pass in openapi requestType and responses to the route.</p>
<p>If you use a custom schema type you should create a schema class that inherits from marshmallow Schema.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">marshmallow</span> <span class="kn">import</span> <span class="n">Schema</span><span class="p">,</span> <span class="n">fields</span>

<span class="c1"># Typed Path Param</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/home/</span><span class="si">{name}</span><span class="s1">/</span><span class="si">{id}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">namer</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="k">class</span> <span class="nc">Point</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Int</span><span class="p">()</span>
    <span class="n">lng</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Int</span><span class="p">()</span>

<span class="c1"># custom schema types</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/points&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">points</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Point</span><span class="p">]:</span>
    <span class="n">point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">({</span><span class="s2">&quot;lat&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;lng&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">})</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">point</span><span class="p">]</span>

<span class="c1"># custom responses and request_types</span>
<span class="c1"># Request body must be schema defition valid with openapi spec 2</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/custom&#39;</span><span class="p">,</span> <span class="n">request_body</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;schema&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">}}},</span> <span class="n">responses</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;400&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;400&#39;</span><span class="p">}})</span>
<span class="k">def</span> <span class="nf">custom</span><span class="p">():</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">current_request</span>
    <span class="k">assert</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span> <span class="p">[</span><span class="s2">&quot;string1&quot;</span><span class="p">,</span> <span class="s2">&quot;string2&quot;</span><span class="p">]</span>
    <span class="k">return</span>

<span class="c1"># Defining Query Params</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/custom&quot;</span><span class="p">,</span><span class="n">query_params</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test2&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}]</span>
<span class="k">def</span> <span class="nf">custom</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
</div>
<div class="section" id="multiple-files">
<h2>Multiple Files<a class="headerlink" href="#multiple-files" title="Permalink to this headline">¶</a></h2>
<p>It is common to split out your api routes into different sub folders. You can do this by creating seperate goblet instances and combining
them in the main.py folder under your main app. You can do this with simple addition notation or with the <code class="docutils literal notranslate"><span class="pre">Goblet.combine</span></code> function</p>
<p>other.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">goblet</span> <span class="kn">import</span> <span class="n">Goblet</span>

<span class="n">otherapp</span> <span class="o">=</span> <span class="n">Goblet</span><span class="p">()</span>

<span class="nd">@otherapp</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/other&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">other</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;other&#39;</span>
</pre></div>
</div>
<p>combine all routes in main.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">goblet</span> <span class="kn">import</span> <span class="n">Goblet</span>
<span class="kn">from</span> <span class="nn">other</span> <span class="kn">import</span> <span class="n">otherapp</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Goblet</span><span class="p">(</span><span class="s1">&#39;main_function&#39;</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">otherapp</span><span class="p">)</span>
<span class="c1"># can also do</span>
<span class="c1"># app + otherapp</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/home&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;home&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="stages">
<h2>Stages<a class="headerlink" href="#stages" title="Permalink to this headline">¶</a></h2>
<p>You can create different deployments of your api (for example dev and prod) using stages. You can create a new stage from the cli using <code class="docutils literal notranslate"><span class="pre">goblet</span> <span class="pre">stage</span> <span class="pre">create</span> <span class="pre">STAGE</span></code> or by
manually adding an entry in config.json under stages. A stage will require a unique function_name which is used to create resources in gcp. Any fields in your stage will
override those in the general config file.</p>
<p>For example the dev deployment will override the environment variable <code class="docutils literal notranslate"><span class="pre">env</span></code> with <code class="docutils literal notranslate"><span class="pre">dev</span></code> and the prod deployment will yield <code class="docutils literal notranslate"><span class="pre">prod</span></code></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;cloudfunction&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;environmentVariables&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;env&quot;</span><span class="p">:</span> <span class="s2">&quot;main&quot;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;stages&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;dev&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;function_name&quot;</span><span class="p">:</span> <span class="s2">&quot;goblet-dev&quot;</span><span class="p">,</span>
            <span class="nt">&quot;cloudfunction&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;environmentVariables&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;dev&quot;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nt">&quot;prod&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;function_name&quot;</span><span class="p">:</span> <span class="s2">&quot;goblet-prod&quot;</span><span class="p">,</span>
            <span class="nt">&quot;cloudfunction&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;environmentVariables&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;prod&quot;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can view your current stages using <code class="docutils literal notranslate"><span class="pre">goblet</span> <span class="pre">stage</span> <span class="pre">list</span></code>. To deploy or destroy a specific stage use the <code class="docutils literal notranslate"><span class="pre">--stage</span></code> or <code class="docutils literal notranslate"><span class="pre">-s</span></code> flag with the stage. You can also use the
environment variable <code class="docutils literal notranslate"><span class="pre">STAGE</span></code>. For example <code class="docutils literal notranslate"><span class="pre">goblet</span> <span class="pre">deploy</span> <span class="pre">-s</span> <span class="pre">dev</span></code>.</p>
</div>
<div class="section" id="api-gateway-backends">
<h2>API Gateway Backends<a class="headerlink" href="#api-gateway-backends" title="Permalink to this headline">¶</a></h2>
<p>Api Gateway supports all available backend services including app engine, GKE, GCE, cloudrun, and cloudfunctions. To add an endpoint to a backend service other than the deployed
cloudfunction, specify the endpoint in the <cite>backend</cite> argment in <cite>route</cite>. Note that the function will not be invoked since the request will be routed to a different backend.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/custom_backend&#39;</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;https://www.CLOUDRUN_URL.com/home&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
    <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="section" id="cors">
<h2>Cors<a class="headerlink" href="#cors" title="Permalink to this headline">¶</a></h2>
<p>Cors can be set on the route level or on the Goblet application level. Setting <cite>cors=True</cite> uses the default cors setting</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;headers&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;Access-Control-Allow-Headers&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;Authorization&quot;</span><span class="p">],</span>
        <span class="nt">&quot;Access-Control-Allow-Origin&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/custom_backend&#39;</span><span class="p">,</span> <span class="n">cors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;cors headers&quot;</span>
</pre></div>
</div>
<p>Use the <cite>CORSConfig</cite> class to set customized cors headers from the <cite>goblet.resources.routes</cite> class.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">goblet.resources.routes</span> <span class="kn">import</span> <span class="n">CORSConfig</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/custom_cors&#39;</span><span class="p">,</span> <span class="n">cors</span><span class="o">=</span><span class="n">CORSConfig</span><span class="p">(</span><span class="n">allow_origin</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">custom_cors</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="s1">&#39;localhost is allowed&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="multiple-cloudfunctions">
<h2>Multiple Cloudfunctions<a class="headerlink" href="#multiple-cloudfunctions" title="Permalink to this headline">¶</a></h2>
<p>Using the field <cite>main_file</cite> in <cite>config.json</cite> allows you to set any file as the entrypoint <cite>main.py</cite> file, which is required by cloudfunctions.
This allows for multiple functions to be deploying using similar code bases.</p>
<p>For example with the following files which each contain a function and share code in <cite>shared.py</cite></p>
<p><cite>func1.py</cite>
<cite>func2.py</cite></p>
<p>Could have the goblet <cite>.config</cite></p>
<p>To test each function locally you can simply run <cite>goblet local -s func1</cite> and to deploy <cite>goblet local -s func1 -p Project -l Region</cite></p>
<p>Note: This may cause some imports to break if something is importing directly from the func1.py or func2.py since they will be renamed to <cite>main.py</cite>
in the packaged zipfile.</p>
<p>Note: There is a bug when uploading a different <cite>main_file</cite>, while also having <cite>main.py</cite> in your code, so if you decide to use <cite>main_file</cite> remove <cite>main.py</cite>. The bug
shows the previos main.py in the gcp console, however the local zipfile and uploaded zipfile in gcs both contain the correct <cite>main.py</cite></p>
</div>
<div class="section" id="syncing-state">
<h2>Syncing State<a class="headerlink" href="#syncing-state" title="Permalink to this headline">¶</a></h2>
<p>The cli command <cite>goblet sync</cite> will sync resources that are deployed in GCP based on the current goblet app configuration. This command will delete resources based on naming
convention that are no longer in the app configuration. For example schuduled jobs start with the function_name prefix so if the function_name is goblet_function
the sync command will flag any scheduled jobs that start with the prefix <cite>goblet_function</cite> that are not in the current app config. Note this may cause some resources
that are named similar to be deleted so make sure to run the command with <cite>–dryrun</cite> flag to see what resources are flagged for deletion.</p>
</div>
<div class="section" id="middleware">
<h2>Middleware<a class="headerlink" href="#middleware" title="Permalink to this headline">¶</a></h2>
<p>You can trigger custom middlware using the <cite>before_request</cite> and <cite>after_request</cite> decorators. These allow you to trigger custom functions before a request is passed to your request
handler or do post prosessing on your responses.</p>
<p>You can have your middleware trigger only on certain event types using the <cite>event_type</cite> argument. Default is <cite>all</cite>. Possible
event types are <cite>[“all”, “http”, “schedule”, “pubsub”, “storage”, “route”]</cite></p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="resources.html" class="btn btn-neutral float-right" title="Resources" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="quickstart.html" class="btn btn-neutral float-left" title="Quickstart" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, austen novis.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>